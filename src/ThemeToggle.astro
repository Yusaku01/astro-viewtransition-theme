---
import ThemeButton from './ThemeButton.astro';

const hasSlot = Astro.slots.has('default');
---

{hasSlot ? <slot /> : <ThemeButton />}

<script>
	const THEME_STORAGE_KEY = 'theme';
	const THEMES = {
		dark: 'dark',
		light: 'light',
	} as const;

	type Theme = (typeof THEMES)[keyof typeof THEMES];

	const getStoredTheme = (): Theme | null => {
		const stored = localStorage.getItem(THEME_STORAGE_KEY);
		if (stored === THEMES.dark || stored === THEMES.light) {
			return stored;
		}
		return null;
	};

	const getPreferredTheme = (): Theme => {
		const stored = getStoredTheme();
		if (stored) {
			return stored;
		}
		return window.matchMedia('(prefers-color-scheme: dark)').matches
			? THEMES.dark
			: THEMES.light;
	};

	const isTheme = (value: string | undefined): value is Theme =>
		value === THEMES.dark || value === THEMES.light;

	const getActiveTheme = (): Theme => {
		const datasetTheme = document.documentElement.dataset.theme;
		return isTheme(datasetTheme) ? datasetTheme : getPreferredTheme();
	};

	const applyTheme = (targetDocument: Document, theme: Theme) => {
		targetDocument.documentElement.dataset.theme = theme;
		targetDocument.documentElement.style.colorScheme = theme;
	};

	const setTheme = (theme: Theme) => {
		localStorage.setItem(THEME_STORAGE_KEY, theme);
		applyTheme(document, theme);
	};

	const syncToggle = () => {
		const buttons = document.querySelectorAll<HTMLButtonElement>('[data-theme-toggle]');
		if (buttons.length === 0) {
			return;
		}

		const theme = getActiveTheme();
		if (!isTheme(document.documentElement.dataset.theme)) {
			applyTheme(document, theme);
		}
		const isDark = theme === THEMES.dark;

		buttons.forEach((button) => {
			const label = button.querySelector<HTMLElement>('[data-theme-label]');

			button.setAttribute('aria-pressed', String(isDark));
			if (label) {
				label.textContent = isDark ? 'Dark' : 'Light';
			}

			if (button.dataset.bound === 'true') {
				return;
			}

			button.dataset.bound = 'true';
			button.addEventListener('click', () => {
				const nextTheme =
					document.documentElement.dataset.theme === THEMES.dark
						? THEMES.light
						: THEMES.dark;
				setTheme(nextTheme);
				syncToggle();
			});
		});
	};

	document.addEventListener('astro:before-swap', (event) => {
		applyTheme(event.newDocument, getActiveTheme());
	});

	document.addEventListener('astro:page-load', () => {
		syncToggle();
	});

	syncToggle();
</script>
